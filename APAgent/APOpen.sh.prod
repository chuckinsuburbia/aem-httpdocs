#!/usr/bin/ksh
################################################################################
#  $1 - Incident ID
#  $2 - Person or group ID
#  $3 - Severity
#  $4 - Alert type
#  $5 - Path ID
#  $6 - AEM Domain Class
#  $7 - AEM Domain
#  $8 - AEM Object Class
#  $9 - AEM Object
# $10 - Text
################################################################################

################################################################################
# Variable declarations
################################################################################
INSTALLDIR=/var/www/html
LOG=${INSTALLDIR}/logs/ap_aem.log
PROGRAM="${INSTALLDIR}/APAgent/APClient.bin"

################################################################################
# Function definitions
################################################################################
function log {
 echo "$(date): $@" >> ${LOG}
}

################################################################################
# Begin processing
################################################################################
log "Received Alert: "$@

[ ${3} != "Critical" ] && log "Not Critical" && exit 0
[ ${7} == "controlm" ] && log "controlm domain suppressed" && exit 0

CMD="${PROGRAM} \"${2}\" \"${3}\" \"${1}\" \"${4}\" \"${5}\" \"${6}\" \"${7}\" \"${8}\" \"${9}\" \"${10}\""

log ${CMD}
RETTEXT=$(${CMD})

if $(echo ${RETTEXT} | grep -q "<subclass>OK</subclass>") ; then
 DT=$(date)
 log "AP submitted OK at "${DT}
 echo ${DT}
else
 log "There was an error with AP agent..."${RETTEXT}
fi
